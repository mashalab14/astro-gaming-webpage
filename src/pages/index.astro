---
// Sample Game - Astro implementation
import Header from '../components/Header.astro';
import GameSurface from '../components/GameSurface.astro';
import WinModal from '../components/WinModal.astro';
import HowToPlay from '../components/HowToPlay.astro';
import Strategies from '../components/Strategies.astro';
import FAQ from '../components/FAQ.astro';
import RelatedGames from '../components/RelatedGames.astro';
import Footer from '../components/Footer.astro';
---

<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sample Game ‚Äì free‚Äëonlinegames.app</title>
  <meta name="description" content="Play Sample Game online. Clean, fast page shell with simple controls, leaderboard, and related games." />
  <meta name="theme-color" content="#0b0c0f" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <meta name="generator" content={Astro.generator} />
  <style>
    /* ===== Base tokens - flat, no shadows ===== */
    :root {
      --bg: #ffffff;
      --text: #111318;
      --muted: #57606a;
      --border: #e6e8eb;
      --link: #1a73e8;
      --surface: #f9f9fb;
      --radius: 4px;
      --table-bg: #4f7942; /* fern green */
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, Noto Sans;
    }
    @media (prefers-color-scheme: dark) {
      :root { --bg:#0b0c0f; --text:#e6e7eb; --muted:#9aa3ad; --border:#1a1d22; --surface:#121418; --link:#6aa1ff; }
    }

    /* ===== Reset-lite ===== */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; overflow-x: hidden; }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: var(--sans); line-height: 1.4; }
    a { color: var(--link); text-decoration: none; }
    a:hover { text-decoration: underline; }
    img { max-width: 100%; display: block; }
    .container { max-width: 1280px; margin: 0 auto; padding: 0 16px; }
    .container.full { max-width: none; padding: 0; }
    .visually-hidden { position: absolute; width:1px; height:1px; margin:-1px; border:0; padding:0; overflow:hidden; clip: rect(0 0 0 0); white-space:nowrap; }

    /* ===== Header styles moved to Header.astro component ===== */

    /* ===== Page layout ===== */
    main { padding: 16px 0 24px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 16px; align-items: start; }
    @media (min-width: 1024px) { .grid { grid-template-columns: 1fr; } }

    /* ===== Hero ===== */
    .hero h1 { margin: 0 0 6px; font-size: 24px; font-weight: 700; }
    .hero .pitch { margin: 0 0 6px; color: var(--muted); }
    .hero .meta { margin: 0; color: var(--muted); font-size: 14px; }
    .hero .trust { margin: 6px 0 0; font-size: 14px; color: var(--muted); }

    /* ===== Game viewport styles moved to GameSurface.astro component ===== */

    /* ===== Content blocks ===== */
    section.block { border-top: 1px solid var(--border); padding-top: 12px; }
    table.simple { width: 100%; border-collapse: collapse; font-size: 14px; }
    table.simple th, table.simple td { padding: 8px 0; border-bottom: 1px solid var(--border); text-align: left; }

    /* ===== Rail ===== */
    .rail { display: none; }
    .rail h3 { margin: 0 0 8px; font-size: 16px; }
    .rail ol, .rail ul { margin: 0; padding-left: 18px; }

    /* ===== Footer ===== */
    footer.site { border-top: 1px solid var(--border); color: var(--muted); font-size: 14px; }
    footer .inner { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; }

    /* ===== Settings dialog ===== */
    dialog.settings { 
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: 1px solid rgba(255, 255, 255, 0.2); 
      border-radius: 12px; 
      padding: 24px; 
      background: color-mix(in srgb, var(--table-bg) 90%, #000); 
      color: #e6e7eb; 
      max-width: 520px; 
      width: calc(100% - 32px);
      backdrop-filter: blur(8px);
      z-index: 1000;
    }
    dialog.settings::backdrop { 
      background: rgba(0, 0, 0, 0.7); 
      backdrop-filter: blur(2px);
    }
    .settings h2 { margin: 0 0 16px; font-size: 24px; font-weight: 600; }
    .settings .row { margin: 16px 0; }
    .swatches { 
      display: grid; 
      grid-template-columns: repeat(8, 24px); 
      gap: 6px; 
      justify-content: start;
    }
    .swatch { 
      width: 24px; 
      height: 24px; 
      border: 1px solid rgba(255, 255, 255, 0.2); 
      border-radius: 4px; 
      cursor: pointer; 
      transition: all 0.2s ease;
    }
    .swatch:hover {
      transform: scale(1.05);
      border-color: rgba(255, 255, 255, 0.4);
    }
    .swatch[aria-pressed="true"] { 
      outline: 2px solid #6aa1ff; 
      outline-offset: 2px; 
      transform: scale(1.05);
    }
    .settings .help { font-size: 13px; color: #9aa3ad; margin-top: 8px; }
    .settings .menu { display: flex; justify-content: flex-end; gap: 8px; margin-top: 20px; }
    
    .close-modal {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      color: #e6e7eb;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1;
    }
    
    .close-modal:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .close-modal:focus-visible {
      outline: 2px solid #6aa1ff;
      outline-offset: 2px;
    }

    /* HUD Toggle Styles */
    .hud-toggles {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toggle-group {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .toggle-group label {
      font-size: 14px;
      color: #e6e7eb;
      font-weight: 500;
    }

    .toggle-btn {
      width: 50px;
      height: 26px;
      border: none;
      border-radius: 13px;
      background: #4CAF50; /* Green when on (default) */
      cursor: pointer;
      position: relative;
      transition: background-color 0.3s ease;
    }

    .toggle-btn[aria-pressed="false"] {
      background: #6B7280; /* Gray when off */
    }

    .toggle-slider {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 22px;
      height: 22px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .toggle-btn[aria-pressed="true"] .toggle-slider {
      transform: translateX(24px);
    }

    .toggle-btn:hover {
      opacity: 0.9;
    }

    .toggle-btn:focus-visible {
      outline: 2px solid #6aa1ff;
      outline-offset: 2px;
    }

    /* Radio Button Groups */
    .radio-groups {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .radio-group-label {
      font-size: 14px;
      color: #e6e7eb;
      font-weight: 500;
    }

    .radio-options {
      display: flex;
      gap: 12px;
    }

    .radio-option {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-size: 14px;
      color: #e6e7eb;
    }

    .radio-option input[type="radio"] {
      width: 16px;
      height: 16px;
      margin: 0 6px 0 0;
      cursor: pointer;
      accent-color: #4CAF50;
    }

    .radio-text {
      user-select: none;
    }

    /* Disabled radio options */
    .radio-option.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .radio-option.disabled input[type="radio"] {
      cursor: not-allowed;
    }

    .radio-option.disabled .radio-text {
      color: #6B7280;
      cursor: not-allowed;
    }

    /* Menu dialog */
    dialog.menu { border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; background: var(--bg); color: var(--text); max-width: 360px; width: calc(100% - 32px); }
    dialog.menu::backdrop { background: rgba(0,0,0,.35); }
    .menu h2 { margin: 0 0 8px; font-size: 18px; }
    .menu .list { display: flex; flex-direction: column; gap: 8px; }
    .menu .btn { width: 100%; text-align: left; height: 36px; }
  </style>
</head>
<body data-game="sample-game">
  <a class="visually-hidden" href="#game">Skip to game</a>

  <!-- <Header /> -->

  <!-- Game Surface takes full viewport -->
  <GameSurface />
  
  <!-- Main content below the game -->
  <main class="container full">
    <h1 class="visually-hidden">Sample Game</h1>
    <div class="grid">
      <div>
        <HowToPlay />
        <Strategies />
        <FAQ />
        <RelatedGames />
      </div>
    </div>
  </main>

  <Footer />

  <!-- Win Modal -->
  <WinModal />

  <!-- Settings dialog -->
  <dialog id="settingsDlg" class="settings" aria-labelledby="settingsTitle">
    <form method="dialog">
      <button class="close-modal" value="cancel" aria-label="Close Settings">√ó</button>
      <h2 id="settingsTitle">Settings</h2>
      <div class="row">
        <div style="font-weight:600; margin-bottom:6px;">Table background</div>
        <div id="swatchGroup" class="swatches" role="group" aria-label="Table background choices">
          <button type="button" class="swatch" data-color="#4f7942" title="Fern Green" aria-pressed="false" style="background:#4f7942"></button>
          <button type="button" class="swatch" data-color="#145239" title="Forest" aria-pressed="false" style="background:#145239"></button>
          <button type="button" class="swatch" data-color="#0b0c0f" title="Charcoal" aria-pressed="false" style="background:#0b0c0f"></button>
          <button type="button" class="swatch" data-color="#1f2933" title="Slate" aria-pressed="false" style="background:#1f2933"></button>
          <button type="button" class="swatch" data-color="#0b2748" title="Midnight Blue" aria-pressed="false" style="background:#0b2748"></button>
          <button type="button" class="swatch" data-color="#0f3d3e" title="Teal" aria-pressed="false" style="background:#0f3d3e"></button>
          <button type="button" class="swatch" data-color="#3f1020" title="Burgundy" aria-pressed="false" style="background:#3f1020"></button>
          <button type="button" class="swatch" data-color="#3a2b1e" title="Brown Felt" aria-pressed="false" style="background:#3a2b1e"></button>
        </div>
      </div>
      <div class="row">
        <div class="hud-toggles">
          <div class="toggle-group">
            <label for="showMovesToggle">Show Moves</label>
            <button type="button" id="showMovesToggle" class="toggle-btn" aria-pressed="true">
              <span class="toggle-slider"></span>
            </button>
          </div>
          <div class="toggle-group">
            <label for="showTimeToggle">Show Time</label>
            <button type="button" id="showTimeToggle" class="toggle-btn" aria-pressed="true">
              <span class="toggle-slider"></span>
            </button>
          </div>
          <div class="toggle-group">
            <label for="soundToggle">Sound</label>
            <button type="button" id="soundToggle" class="toggle-btn" aria-pressed="true">
              <span class="toggle-slider"></span>
            </button>
          </div>
          <div class="toggle-group">
            <label for="animationsToggle">Animations</label>
            <button type="button" id="animationsToggle" class="toggle-btn" aria-pressed="true">
              <span class="toggle-slider"></span>
            </button>
          </div>
          <div class="toggle-group">
            <label for="showScoreToggle">Show Score</label>
            <button type="button" id="showScoreToggle" class="toggle-btn" aria-pressed="true">
              <span class="toggle-slider"></span>
            </button>
          </div>
          <div class="toggle-group">
            <label for="showStockToggle">Show Stock</label>
            <button type="button" id="showStockToggle" class="toggle-btn" aria-pressed="true">
              <span class="toggle-slider"></span>
            </button>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="radio-groups">
          <div class="radio-group">
            <label class="radio-group-label">Autoplay</label>
            <div class="radio-options">
              <label class="radio-option">
                <input type="radio" name="autoplay" value="off" />
                <span class="radio-text">Off</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="autoplay" value="obvious" checked />
                <span class="radio-text">When Obvious</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="autoplay" value="won" />
                <span class="radio-text">When Won</span>
              </label>
            </div>
          </div>
          <div class="radio-group">
            <label class="radio-group-label">Animation Speed</label>
            <div class="radio-options">
              <label class="radio-option">
                <input type="radio" name="animationSpeed" value="slow" />
                <span class="radio-text">Slow</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="animationSpeed" value="normal" checked />
                <span class="radio-text">Normal</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="animationSpeed" value="fast" />
                <span class="radio-text">Fast</span>
              </label>
            </div>
          </div>
        </div>
      </div>
    </form>
  </dialog>

  <dialog id="menuDlg" class="menu" aria-labelledby="menuTitle">
    <form method="dialog">
      <h2 id="menuTitle">Menu</h2>
      <div class="list">
        <button id="resumeBtn" class="btn" value="default" type="button">Resume</button>
        <button id="restartMenuBtn" class="btn" type="button">Restart</button>
        <button id="openSettingsBtn" class="btn" type="button">Settings</button>
        <button class="btn" value="cancel">Close</button>
      </div>
    </form>
  </dialog>

  <script>
    // Minimal demo logic + table background preference.
    (function() {
      const root = document.documentElement;
      
      const edgeMenuBtn = document.getElementById('edgeMenuBtn');
      const menuDlg = document.getElementById('menuDlg');
      
      const gameEngineMount = document.getElementById('gameEngineMount');
      
      const settingsDlg = document.getElementById('settingsDlg');
      const swatchGroup = document.getElementById('swatchGroup');
      const viewport = document.getElementById('game');
      const pauseOverlay = document.getElementById('pauseOverlay');
      const GAME_SLUG = document.body.dataset.game || 'sample-game';

      // Table background color persistence
      const DEFAULT_VELVET = '#4f7942';
      const gameKey = `tableBg.game.${GAME_SLUG}`;
      const globalKey = 'tableBg.default';
      function currentBg() {
        return localStorage.getItem(gameKey) || localStorage.getItem(globalKey) || DEFAULT_VELVET;
      }
      function applyBg(color) { document.documentElement.style.setProperty('--table-bg', color); }
      function markSelected(color) {
        const buttons = swatchGroup.querySelectorAll('.swatch');
        buttons.forEach(b => b.setAttribute('aria-pressed', String(b.dataset.color.toLowerCase() === color.toLowerCase())));
      }
      // init
      applyBg(currentBg());
      markSelected(currentBg());

      // swatch clicks
      swatchGroup.addEventListener('click', (e) => {
        const btn = e.target.closest('.swatch'); if (!btn) return;
        const color = btn.dataset.color;
        applyBg(color); markSelected(color);
        localStorage.setItem(gameKey, color);
      });

      // HUD Toggle functionality
      const showMovesToggle = document.getElementById('showMovesToggle');
      const showTimeToggle = document.getElementById('showTimeToggle');
      const showScoreToggle = document.getElementById('showScoreToggle');
      const showStockToggle = document.getElementById('showStockToggle');
      const hudMoves = document.getElementById('hudMoves');
      const hudTime = document.getElementById('hudTime');
      const hudScore = document.getElementById('hudScore');
      const hudStock = document.getElementById('hudStock');

      // HUD preferences keys
      const movesKey = 'hud.showMoves';
      const timeKey = 'hud.showTime';
      const scoreKey = 'hud.showScore';
      const stockKey = 'hud.showStock';

      // Get saved preferences (default to true)
      function getMovesPreference() {
        const saved = localStorage.getItem(movesKey);
        return saved === null ? true : saved === 'true';
      }
      
      function getTimePreference() {
        const saved = localStorage.getItem(timeKey);
        return saved === null ? true : saved === 'true';
      }
      
      function getScorePreference() {
        const saved = localStorage.getItem(scoreKey);
        return saved === null ? true : saved === 'true';
      }
      
      function getStockPreference() {
        const saved = localStorage.getItem(stockKey);
        return saved === null ? true : saved === 'true';
      }

      // Apply HUD visibility
      function applyHudVisibility() {
        const showMoves = getMovesPreference();
        const showTime = getTimePreference();
        const showScore = getScorePreference();
        const showStock = getStockPreference();
        
        if (hudMoves) hudMoves.style.display = showMoves ? 'block' : 'none';
        if (hudTime) hudTime.style.display = showTime ? 'block' : 'none';
        if (hudScore) hudScore.style.display = showScore ? 'block' : 'none';
        if (hudStock) hudStock.style.display = showStock ? 'block' : 'none';
        
        if (showMovesToggle) showMovesToggle.setAttribute('aria-pressed', String(showMoves));
        if (showTimeToggle) showTimeToggle.setAttribute('aria-pressed', String(showTime));
        if (showScoreToggle) showScoreToggle.setAttribute('aria-pressed', String(showScore));
        if (showStockToggle) showStockToggle.setAttribute('aria-pressed', String(showStock));
      }

      // Toggle event listeners
      showMovesToggle?.addEventListener('click', () => {
        const current = getMovesPreference();
        const newValue = !current;
        localStorage.setItem(movesKey, String(newValue));
        applyHudVisibility();
      });

      showTimeToggle?.addEventListener('click', () => {
        const current = getTimePreference();
        const newValue = !current;
        localStorage.setItem(timeKey, String(newValue));
        applyHudVisibility();
      });

      showScoreToggle?.addEventListener('click', () => {
        const current = getScorePreference();
        const newValue = !current;
        localStorage.setItem(scoreKey, String(newValue));
        applyHudVisibility();
      });

      showStockToggle?.addEventListener('click', () => {
        const current = getStockPreference();
        const newValue = !current;
        localStorage.setItem(stockKey, String(newValue));
        applyHudVisibility();
      });

      // Initialize HUD visibility on page load
      applyHudVisibility();

      // New Settings functionality
      const soundToggle = document.getElementById('soundToggle');
      const animationsToggle = document.getElementById('animationsToggle');
      const autoplayRadios = document.querySelectorAll('input[name="autoplay"]');
      const animationSpeedRadios = document.querySelectorAll('input[name="animationSpeed"]');

      // Settings keys
      const soundKey = 'game.sound';
      const animationsKey = 'game.animations';
      const autoplayKey = 'game.autoplay';
      const animationSpeedKey = 'game.animationSpeed';

      // Get preferences with defaults
      function getSoundPreference() {
        const saved = localStorage.getItem(soundKey);
        return saved === null ? true : saved === 'true';
      }

      function getAnimationsPreference() {
        const saved = localStorage.getItem(animationsKey);
        return saved === null ? true : saved === 'true';
      }

      function getAutoplayPreference() {
        return localStorage.getItem(autoplayKey) || 'obvious';
      }

      function getAnimationSpeedPreference() {
        return localStorage.getItem(animationSpeedKey) || 'normal';
      }

      // Apply settings
      function applySettings() {
        const sound = getSoundPreference();
        const animations = getAnimationsPreference();
        const autoplay = getAutoplayPreference();
        const animationSpeed = getAnimationSpeedPreference();

        if (soundToggle) soundToggle.setAttribute('aria-pressed', String(sound));
        if (animationsToggle) animationsToggle.setAttribute('aria-pressed', String(animations));

        // Set radio button selections
        autoplayRadios.forEach(radio => {
          radio.checked = radio.value === autoplay;
        });

        animationSpeedRadios.forEach(radio => {
          radio.checked = radio.value === animationSpeed;
        });

        // Enable/disable Animation Speed based on Animations toggle
        animationSpeedRadios.forEach(radio => {
          radio.disabled = !animations;
          const radioOption = radio.closest('.radio-option');
          if (radioOption) {
            if (animations) {
              radioOption.classList.remove('disabled');
            } else {
              radioOption.classList.add('disabled');
            }
          }
        });
      }

      // Toggle event listeners
      soundToggle?.addEventListener('click', () => {
        const current = getSoundPreference();
        const newValue = !current;
        localStorage.setItem(soundKey, String(newValue));
        applySettings();
      });

      animationsToggle?.addEventListener('click', () => {
        const current = getAnimationsPreference();
        const newValue = !current;
        localStorage.setItem(animationsKey, String(newValue));
        applySettings();
      });

      // Radio button event listeners
      autoplayRadios.forEach(radio => {
        radio.addEventListener('change', () => {
          if (radio.checked) {
            localStorage.setItem(autoplayKey, radio.value);
          }
        });
      });

      animationSpeedRadios.forEach(radio => {
        radio.addEventListener('change', () => {
          if (radio.checked) {
            localStorage.setItem(animationSpeedKey, radio.value);
          }
        });
      });

      // Initialize settings on page load
      applySettings();

      // Language Selection functionality
      const languageSelect = document.getElementById('languageSelect');
      const languageKey = 'user.language';

      // Language names in their own languages
      const languageNames = {
        'en': 'English',
        'de': 'Deutsch',
        'fr': 'Fran√ßais',
        'es': 'Espa√±ol',
        'it': 'Italiano',
        'pt': 'Portugu√™s',
        'nl': 'Nederlands',
        'sv': 'Svenska',
        'da': 'Dansk',
        'no': 'Norsk',
        'fi': 'Suomi',
        'pl': 'Polski',
        'cs': 'ƒåe≈°tina',
        'hu': 'Magyar',
        'ro': 'Rom√¢nƒÉ',
        'bg': '–ë—ä–ª–≥–∞—Ä—Å–∫–∏',
        'hr': 'Hrvatski',
        'sr': 'Srpski',
        'sl': 'Sloven≈°ƒçina',
        'sk': 'Slovenƒçina',
        'et': 'Eesti',
        'lv': 'Latvie≈°u',
        'lt': 'Lietuvi≈≥',
        'el': 'ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨',
        'ru': '–†—É—Å—Å–∫–∏–π',
        'uk': '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞',
        'ja': 'Êó•Êú¨Ë™û'
      };

      // Get saved language preference (default to English)
      function getLanguagePreference() {
        return localStorage.getItem(languageKey) || 'en';
      }

      // Set language selection and display
      function applyLanguageSelection() {
        const selectedLang = getLanguagePreference();
        if (languageSelect) {
          languageSelect.value = selectedLang;
        }
      }

      // Language selection event listener
      languageSelect?.addEventListener('change', (e) => {
        const selectedLang = e.target.value;
        localStorage.setItem(languageKey, selectedLang);
        console.log(`Language changed to: ${languageNames[selectedLang]} (${selectedLang})`);
      });

      // Initialize language selection on page load
      applyLanguageSelection();

      // Settings modal behavior
      function showSettings() {
        if (typeof settingsDlg.showModal === 'function') {
          settingsDlg.showModal();
        } else {
          settingsDlg.setAttribute('open', '');
        }
        pauseGame(); // Pause game when settings open
      }

      function closeSettings() {
        if (settingsDlg.open) {
          settingsDlg.close();
        }
        // Game remains paused - user can resume manually
      }

      // Settings button event listener
      const vpSettingsBtn = document.getElementById('vpSettingsBtn');
      vpSettingsBtn?.addEventListener('click', () => {
        showSettings();
      });

      // Close settings when clicking outside
      settingsDlg.addEventListener('click', (e) => {
        const rect = settingsDlg.getBoundingClientRect();
        const isInDialog = (rect.top <= e.clientY && e.clientY <= rect.top + rect.height &&
                          rect.left <= e.clientX && e.clientX <= rect.left + rect.width);
        if (!isInDialog) {
          closeSettings();
        }
      });

      // Close settings with Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && settingsDlg.open) {
          e.preventDefault();
          closeSettings();
        }
      });

      // Minimal control model: no visible play/pause/restart. Menu + shortcuts.
      let running = false; let secs = 0; let timerId = null;

      function showMenu() {
        if (typeof menuDlg.showModal === 'function') menuDlg.showModal();
        else menuDlg.setAttribute('open', '');
      }
      function closeMenu() { if (menuDlg.open) menuDlg.close(); }
      function pauseGame() { running = false; pauseOverlay.classList.add('show'); if (timerId) { clearInterval(timerId); timerId = null; } }
      function resumeGame() { running = true; pauseOverlay.classList.remove('show'); if (!timerId) { timerId = setInterval(() => { secs++; const mm = String(Math.floor(secs/60)).padStart(2,'0'); const ss = String(secs%60).padStart(2,'0'); const ht = document.getElementById('hudTime'); if (ht) ht.textContent = `${mm}:${ss}`; }, 1000); } }

      const resumeBtn = document.getElementById('resumeBtn');
      const restartMenuBtn = document.getElementById('restartMenuBtn');
      const openSettingsBtn = document.getElementById('openSettingsBtn');

      edgeMenuBtn?.addEventListener('click', () => { showMenu(); });
      resumeBtn?.addEventListener('click', () => { resumeGame(); closeMenu(); });
      restartMenuBtn?.addEventListener('click', () => { secs = 0; const ht = document.getElementById('hudTime'); if (ht) ht.textContent = '00:00'; resumeGame(); closeMenu(); });

      // Wire up New Deal button to engine interface
      const newDealBtn = document.getElementById('newDealBtn');
      newDealBtn?.addEventListener('click', () => {
        // Reset game stats
        secs = 0;
        const hudTime = document.getElementById('hudTime');
        const hudMoves = document.getElementById('hudMoves');
        const hudScore = document.getElementById('hudScore');
        const hudStock = document.getElementById('hudStock');
        
        if (hudTime) hudTime.textContent = '00:00';
        if (hudMoves) hudMoves.textContent = 'Moves 0';
        if (hudScore) hudScore.textContent = 'Score 0';
        if (hudStock) hudStock.textContent = 'Stock 24';
        
        // Call engine's startNewDeal() when available
        // gameEngine?.startNewDeal();
        
        resumeGame();
      });
      openSettingsBtn?.addEventListener('click', () => { closeMenu(); markSelected(currentBg()); if (typeof settingsDlg.showModal === 'function') settingsDlg.showModal(); else settingsDlg.setAttribute('open',''); });

      // Start/resume on first pointer in the game engine mount
      gameEngineMount?.addEventListener('pointerdown', () => { resumeGame(); });

      // ===== GAME ENGINE INTEGRATION =====
      
      let gameEngine = {
        startNewDeal: () => {},
        updateOptions: (options) => {},
        destroy: () => {}
      };
      let gameStats = {
        gamesPlayed: parseInt(localStorage.getItem('stats.gamesPlayed') || '0'),
        gamesWon: parseInt(localStorage.getItem('stats.gamesWon') || '0'),
        deals: parseInt(localStorage.getItem('stats.deals') || '0')
      };
      
      // Timer system
      let gameTimer = {
        startTime: null,
        elapsed: 0,
        isRunning: false,
        interval: null
      };
      
      function startTimer() {
        if (gameTimer.isRunning) return;
        gameTimer.startTime = Date.now();
        gameTimer.isRunning = true;
        gameTimer.interval = setInterval(() => {
          gameTimer.elapsed = Math.floor((Date.now() - gameTimer.startTime) / 1000);
          updateTimerDisplay();
        }, 1000);
      }
      
      function stopTimer() {
        gameTimer.isRunning = false;
        if (gameTimer.interval) {
          clearInterval(gameTimer.interval);
          gameTimer.interval = null;
        }
      }
      
      function resetTimer() {
        stopTimer();
        gameTimer.elapsed = 0;
        gameTimer.startTime = null;
        updateTimerDisplay();
      }
      
      function updateTimerDisplay() {
        const minutes = Math.floor(gameTimer.elapsed / 60);
        const seconds = gameTimer.elapsed % 60;
        const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        const hudTime = document.getElementById('hudTime');
        if (hudTime) hudTime.textContent = timeStr;
      }
      
      // Shell callbacks for game engine
      const shellCallbacks = {
        onFirstMove: () => {
          console.log('üéÆ First move detected, starting timer');
          startTimer();
        },
        
        onMove: (moveData) => {
          console.log('üéÆ Move:', moveData);
          // Update HUD elements
          const hudMoves = document.getElementById('hudMoves');
          const hudScore = document.getElementById('hudScore');
          const hudStock = document.getElementById('hudStock');
          
          if (hudMoves) hudMoves.textContent = `Moves ${moveData.moves}`;
          if (hudScore) hudScore.textContent = `Score ${moveData.score}`;
          if (hudStock && moveData.stockCount !== undefined) {
            hudStock.textContent = `Stock ${moveData.stockCount}`;
          }
        },
        
        onWin: (winData) => {
          console.log('üéâ Game won!', winData);
          stopTimer();
          gameStats.gamesWon++;
          localStorage.setItem('stats.gamesWon', gameStats.gamesWon.toString());
          showWinModal(winData);
        },
        
        onLoss: (lossData) => {
          console.log('üòû Game lost', lossData);
          stopTimer();
          // Could show loss modal here if needed
        },
        
        onReset: () => {
          console.log('üîÑ Game reset');
          resetTimer();
          gameStats.deals++;
          gameStats.gamesPlayed++;
          localStorage.setItem('stats.deals', gameStats.deals.toString());
          localStorage.setItem('stats.gamesPlayed', gameStats.gamesPlayed.toString());
        }
      };
      
      // Win modal functions
      function showWinModal(winData) {
        const winModal = document.getElementById('winModal');
        const winTime = document.getElementById('winTime');
        const winMoves = document.getElementById('winMoves');
        const winScore = document.getElementById('winScore');
        const winGamesWon = document.getElementById('winGamesWon');
        const winRate = document.getElementById('winRate');
        
        if (winTime) winTime.textContent = winData.timeDisplay || formatTime(winData.timeSeconds || gameTimer.elapsed);
        if (winMoves) winMoves.textContent = winData.moves.toString();
        if (winScore) winScore.textContent = winData.score.toString();
        if (winGamesWon) winGamesWon.textContent = gameStats.gamesWon.toString();
        
        const rate = gameStats.gamesPlayed > 0 ? Math.round((gameStats.gamesWon / gameStats.gamesPlayed) * 100) : 0;
        if (winRate) winRate.textContent = `${rate}%`;
        
        if (winModal && typeof winModal.showModal === 'function') {
          winModal.showModal();
        } else if (winModal) {
          winModal.setAttribute('open', '');
        }
      }
      
      function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      }
      
      // Simple fake game implementation
      const fakeGameState = {
        moves: 0,
        score: 0,
        stockCount: 24,
        isWon: false
      };
      
      // Initialize the fake game engine
      function initializeGameEngine() {
        const gameEngineMount = document.getElementById('stage');
        if (!gameEngineMount) {
          console.error('Game mount point not found');
          return;
        }
        
        // Create fake game interface
        gameEngineMount.innerHTML = `
          <div style="
            padding: 20px;
            text-align: center;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            max-height: 100%;
            overflow: hidden;
            box-sizing: border-box;
          ">
            <div style="
              font-size: 20px;
              font-weight: bold;
              color: #e6e7eb;
              margin-bottom: 8px;
            ">
              üéÆ Klondike Solitaire
            </div>
            
            <div style="
              font-size: 12px;
              color: #9aa3ad;
              margin-bottom: 16px;
              line-height: 1.3;
            ">
              Fake game for testing shell integration<br>
              Click buttons below to simulate game actions
            </div>

            <div style="
              display: grid;
              grid-template-columns: repeat(4, 50px);
              gap: 8px;
              margin-bottom: 16px;
              justify-content: center;
            ">
              <div style="width:50px;height:65px;border:2px solid #555;border-radius:4px;background:#333;display:flex;align-items:center;justify-content:center;color:#888;font-size:18px;">‚ô†Ô∏è</div>
              <div style="width:50px;height:65px;border:2px solid #555;border-radius:4px;background:#333;display:flex;align-items:center;justify-content:center;color:#888;font-size:18px;">‚ô•Ô∏è</div>
              <div style="width:50px;height:65px;border:2px solid #555;border-radius:4px;background:#333;display:flex;align-items:center;justify-content:center;color:#888;font-size:18px;">‚ô¶Ô∏è</div>
              <div style="width:50px;height:65px;border:2px solid #555;border-radius:4px;background:#333;display:flex;align-items:center;justify-content:center;color:#888;font-size:18px;">‚ô£Ô∏è</div>
            </div>

            <div style="
              display: flex;
              gap: 10px;
              flex-wrap: wrap;
              justify-content: center;
            ">
              <button id="fakeMove" style="
                padding: 6px 12px;
                border: 1px solid rgba(76, 175, 80, 0.5);
                border-radius: 4px;
                background: rgba(76, 175, 80, 0.2);
                color: #4CAF50;
                cursor: pointer;
                font-size: 12px;
                font-weight: 500;
              ">
                Make Move (+10)
              </button>
              
              <button id="fakeWin" style="
                padding: 6px 12px;
                border: 1px solid rgba(255, 193, 7, 0.5);
                border-radius: 4px;
                background: rgba(255, 193, 7, 0.2);
                color: #FFC107;
                cursor: pointer;
                font-size: 12px;
                font-weight: 500;
              ">
                Trigger Win
              </button>
            </div>
          </div>
        `;
        
        // Add event listeners for fake game actions
        const fakeMoveBtn = document.getElementById('fakeMove');
        const fakeWinBtn = document.getElementById('fakeWin');
        
        fakeMoveBtn?.addEventListener('click', () => {
          if (fakeGameState.moves === 0) {
            shellCallbacks.onFirstMove();
          }
          
          fakeGameState.moves++;
          fakeGameState.score += 10;
          fakeGameState.stockCount = Math.max(0, fakeGameState.stockCount - 1);
          
          shellCallbacks.onMove({
            moves: fakeGameState.moves,
            score: fakeGameState.score,
            stockCount: fakeGameState.stockCount
          });
        });
        
        fakeWinBtn?.addEventListener('click', () => {
          fakeGameState.isWon = true;
          shellCallbacks.onWin({
            moves: fakeGameState.moves,
            score: fakeGameState.score,
            timeSeconds: gameTimer.elapsed
          });
        });
        
        // Initialize game engine object for compatibility
        gameEngine = {
          startNewDeal: () => {
            console.log('üîÑ Starting new deal');
            fakeGameState.moves = 0;
            fakeGameState.score = 0;
            fakeGameState.stockCount = 24;
            fakeGameState.isWon = false;
            shellCallbacks.onReset();
          },
          
          updateOptions: (newOptions) => {
            console.log('‚öôÔ∏è Updating game options:', newOptions);
          },
          
          destroy: () => {
            console.log('üí• Game engine destroyed');
          }
        };
        
        console.log('üéÆ Fake game engine initialized');
      }
      
      // Helper functions for preferences (renamed to avoid conflicts)
      function gameAutoplayPreference() {
        return localStorage.getItem('game.autoplay') || 'whenObvious';
      }
      
      function gameAnimationSpeedPreference() {
        return localStorage.getItem('game.animationSpeed') || 'normal';
      }
      
      function gameSoundPreference() {
        return localStorage.getItem('game.sound') !== 'false';
      }
      
      function gameAnimationPreference() {
        return localStorage.getItem('game.animations') !== 'false';
      }
      
      function gameHUDPreference(hudElement) {
        return localStorage.getItem(`hud.${hudElement}`) !== 'false';
      }
      
      // Header button event listeners
      const newGameBtn = document.getElementById('newGameBtn');
      const pauseBtn = document.getElementById('pauseBtn');
      const autoplayBtn = document.getElementById('autoplayBtn');
      
      newGameBtn?.addEventListener('click', () => {
        console.log('üéÆ New Game button clicked');
        if (gameEngine) {
          gameEngine.startNewDeal();
        }
      });
      
      pauseBtn?.addEventListener('click', () => {
        console.log('‚è∏Ô∏è Pause button clicked');
        if (gameTimer.isRunning) {
          pauseGame();
          pauseBtn.textContent = 'Resume';
        } else {
          resumeGame();
          pauseBtn.textContent = 'Pause';
        }
      });
      
      autoplayBtn?.addEventListener('click', () => {
        console.log('ü§ñ Autoplay button clicked');
        // Toggle autoplay mode
        const currentAutoplay = gameAutoplayPreference();
        const newAutoplay = currentAutoplay === 'off' ? 'whenObvious' : 'off';
        localStorage.setItem('game.autoplay', newAutoplay);
        
        // Update button text
        autoplayBtn.textContent = newAutoplay === 'off' ? 'Autoplay' : 'Auto: ' + newAutoplay;
        
        // Notify game engine of preference change
        if (gameEngine && gameEngine.updateOptions) {
          gameEngine.updateOptions({ autoplay: newAutoplay });
        }
      });
      
      // Initialize header button text
      function initializeHeaderButtons() {
        if (autoplayBtn) {
          const autoplay = gameAutoplayPreference();
          autoplayBtn.textContent = autoplay === 'off' ? 'Autoplay' : 'Auto: ' + autoplay;
        }
        
        if (pauseBtn) {
          pauseBtn.textContent = gameTimer.isRunning ? 'Pause' : 'Resume';
        }
      }
      
      // Win modal event listeners
      const playAgainBtn = document.getElementById('playAgainBtn');
      const shareScoreBtn = document.getElementById('shareScoreBtn');
      
      playAgainBtn?.addEventListener('click', () => {
        const winModal = document.getElementById('winModal');
        if (winModal) winModal.close();
        
        if (gameEngine) {
          gameEngine.startNewDeal();
        }
      });
      
      shareScoreBtn?.addEventListener('click', () => {
        const timeText = document.getElementById('winTime')?.textContent || '00:00';
        const movesText = document.getElementById('winMoves')?.textContent || '0';
        const scoreText = document.getElementById('winScore')?.textContent || '0';
        
        const shareText = `I just won Klondike Solitaire! Time: ${timeText}, Moves: ${movesText}, Score: ${scoreText}`;
        
        if (navigator.share) {
          navigator.share({
            title: 'Klondike Solitaire Win!',
            text: shareText
          });
        } else {
          navigator.clipboard.writeText(shareText).then(() => {
            alert('Score copied to clipboard!');
          });
        }
      });
      
      // Initialize everything when DOM is ready
      initializeGameEngine();
      initializeHeaderButtons();

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
        if (tag === 'input' || tag === 'textarea' || tag === 'select') return;
        if (e.key === 'Escape') { e.preventDefault(); menuDlg.open ? closeMenu() : showMenu(); }
        else if (e.key.toLowerCase() === 'p') { e.preventDefault(); running ? pauseGame() : resumeGame(); }
        else if (e.key.toLowerCase() === 'r') { e.preventDefault(); resumeGame(); }
        else if (e.key === ' ') { e.preventDefault(); resumeGame(); }
      });

      // Auto-pause on focus loss
      window.addEventListener('blur', () => { if (running) { running = false; pauseOverlay.classList.add('show'); } });

      // ===== Game Switcher logic =====
      const switcherBtn = document.getElementById('gameSwitcherBtn');
      const switcherMenu = document.getElementById('gameSwitcherMenu');
      const gsSearch = document.getElementById('gsSearch');
      const gsAll = document.getElementById('gsAll');
      const gsRecent = document.getElementById('gsRecent');
      const gsPinned = document.getElementById('gsPinned');

      const ALL_GAMES = [
        { slug:'minesweeper-classic', title:'Minesweeper Classic', meta:'Puzzle ¬∑ Single player' },
        { slug:'klondike-solitaire', title:'Klondike Solitaire', meta:'Card ¬∑ Single player' },
        { slug:'spider-solitaire', title:'Spider Solitaire', meta:'Card ¬∑ Single player' },
        { slug:'hearts', title:'Hearts', meta:'Card ¬∑ Multiplayer' },
        { slug:'freecell', title:'FreeCell', meta:'Card ¬∑ Single player' },
        { slug:'2048', title:'2048', meta:'Puzzle ¬∑ Single player' }
      ];

      let menuInitialized = false;

      function getPinned() { try { return JSON.parse(localStorage.getItem('gs.pins')||'[]'); } catch { return []; } }
      function setPinned(arr) { localStorage.setItem('gs.pins', JSON.stringify(arr.slice(0,50))); }
      function getRecents() { try { return JSON.parse(localStorage.getItem('gs.recents')||'[]'); } catch { return []; } }
      function setRecents(arr) { localStorage.setItem('gs.recents', JSON.stringify(arr.slice(0,50))); }
      function addRecent(slug) {
        const now = Date.now();
        const rec = getRecents().filter(r => r.slug !== slug);
        rec.unshift({ slug, t: now });
        setRecents(rec);
      }
      function gameBySlug(slug) { return ALL_GAMES.find(g => g.slug === slug); }

      function renderOptions(container, items) {
        container.innerHTML = '';
        items.forEach(g => {
          const row = document.createElement('div');
          row.className = 'option';
          row.setAttribute('role','option');
          row.setAttribute('tabindex','-1');
          row.dataset.slug = g.slug;
          row.innerHTML = `<div class="text"><div class="title">${g.title}</div><div class="meta">${g.meta||''}</div></div>`;
          const pin = document.createElement('button');
          pin.className = 'pinbtn';
          const pinned = getPinned().includes(g.slug);
          pin.textContent = pinned ? 'Unpin' : 'Pin';
          pin.setAttribute('aria-pressed', String(pinned));
          pin.addEventListener('click', (e) => {
            e.stopPropagation();
            const pins = getPinned();
            if (pinned) setPinned(pins.filter(s => s !== g.slug)); else { pins.unshift(g.slug); setPinned(pins); }
            // Re-render sections
            populateSections();
          });
          row.appendChild(pin);
          row.addEventListener('click', () => selectGame(g.slug));
          container.appendChild(row);
        });
      }

      function populateSections(filter = '') {
        const f = filter.trim().toLowerCase();
        const all = f ? ALL_GAMES.filter(g => g.title.toLowerCase().includes(f) || g.slug.includes(f)) : ALL_GAMES;
        const rec = getRecents().map(r => gameBySlug(r.slug)).filter(Boolean);
        const pins = getPinned().map(s => gameBySlug(s)).filter(Boolean);
        renderOptions(gsPinned, pins);
        renderOptions(gsRecent, rec);
        renderOptions(gsAll, all);
        // Focus first option after filtering
        const first = switcherMenu.querySelector('.option');
        if (first) first.focus();
      }

      function openMenu() {
        if (!menuInitialized) { populateSections(); menuInitialized = true; }
        switcherMenu.hidden = false;
        switcherBtn.setAttribute('aria-expanded','true');
        gsSearch.focus();
        document.addEventListener('keydown', onMenuKey);
        document.addEventListener('click', onDocClick, true);
      }
      function closeMenu() {
        switcherMenu.hidden = true;
        switcherBtn.setAttribute('aria-expanded','false');
        document.removeEventListener('keydown', onMenuKey);
        document.removeEventListener('click', onDocClick, true);
        switcherBtn.focus();
      }
      function onDocClick(e) {
        if (e.target === switcherBtn || switcherMenu.contains(e.target)) return;
        closeMenu();
      }
      function onMenuKey(e) {
        if (e.key === 'Escape') { e.preventDefault(); closeMenu(); return; }
        const options = Array.from(switcherMenu.querySelectorAll('.option'));
        const idx = options.indexOf(document.activeElement);
        if (e.key === 'ArrowDown') { e.preventDefault(); (options[idx+1]||options[0])?.focus(); }
        else if (e.key === 'ArrowUp') { e.preventDefault(); (options[idx-1]||options[options.length-1])?.focus(); }
        else if (e.key === 'Home') { e.preventDefault(); options[0]?.focus(); }
        else if (e.key === 'End') { e.preventDefault(); options[options.length-1]?.focus(); }
        else if (e.key === 'Enter' && document.activeElement?.classList.contains('option')) { e.preventDefault(); document.activeElement.click(); }
      }
      function selectGame(slug) {
        addRecent(slug);
        // Navigate to the game page. Replace with router navigation if needed.
        window.location.href = `/game/${slug}`;
      }

      switcherBtn?.addEventListener('click', () => {
        const expanded = switcherBtn.getAttribute('aria-expanded') === 'true';
        expanded ? closeMenu() : openMenu();
      });
      switcherBtn?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openMenu(); }
      });
      gsSearch?.addEventListener('input', (e) => populateSections(e.target.value));
    })();
  </script>
</body>
</html>
