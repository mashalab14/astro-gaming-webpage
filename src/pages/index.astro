---
// Sample Game - Astro implementation
import GameSurface from '../components/GameSurface.astro';
import WinModal from '../components/WinModal.astro';
import HowToPlay from '../components/HowToPlay.astro';
import Strategies from '../components/Strategies.astro';
import FAQ from '../components/FAQ.astro';
import RelatedGames from '../components/RelatedGames.astro';
import Footer from '../components/Footer.astro';
---

<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sample Game ‚Äì free‚Äëonlinegames.app</title>
  <meta name="description" content="Play Sample Game online. Clean, fast page shell with simple controls, leaderboard, and related games." />
  <meta name="theme-color" content="#0b0c0f" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet">
  <meta name="generator" content={Astro.generator} />
  <style>
    /* ===== Base tokens - flat, no shadows ===== */
    :root {
      --bg: #ffffff;
      --text: #111318;
      --muted: #57606a;
      --border: #e6e8eb;
      --link: #1a73e8;
      --surface: #f9f9fb;
      --radius: 4px;
      --table-bg: #4f7942; /* fern green */
      --sans: "DM Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    @media (prefers-color-scheme: dark) {
      :root { --bg:#0b0c0f; --text:#e6e7eb; --muted:#9aa3ad; --border:#1a1d22; --surface:#121418; --link:#6aa1ff; }
    }

    /* ===== Reset-lite ===== */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; overflow-x: hidden; }
    body { 
      margin: 0; 
      background: var(--bg); 
      color: var(--text); 
      font-family: var(--sans); 
      line-height: 1.4;
      /* Disable text selection and context menu */
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }
    a { color: var(--link); text-decoration: none; }
    a:hover { text-decoration: underline; }
    img { max-width: 100%; display: block; }
    .container { max-width: 1280px; margin: 0 auto; padding: 0 16px; }
    .container.full { max-width: none; padding: 0; }
    .visually-hidden { position: absolute; width:1px; height:1px; margin:-1px; border:0; padding:0; overflow:hidden; clip: rect(0 0 0 0); white-space:nowrap; }



    /* ===== Page layout ===== */
    main { padding: 16px 0 24px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 16px; align-items: start; }
    @media (min-width: 1024px) { .grid { grid-template-columns: 1fr; } }

    /* ===== Hero ===== */
    .hero h1 { margin: 0 0 6px; font-size: 24px; font-weight: 700; }
    .hero .pitch { margin: 0 0 6px; color: var(--muted); }
    .hero .meta { margin: 0; color: var(--muted); font-size: 14px; }
    .hero .trust { margin: 6px 0 0; font-size: 14px; color: var(--muted); }

    /* ===== Game viewport styles moved to GameSurface.astro component ===== */

    /* ===== Content blocks ===== */
    section.block { border-top: 1px solid var(--border); padding-top: 12px; }
    table.simple { width: 100%; border-collapse: collapse; font-size: 14px; }
    table.simple th, table.simple td { padding: 8px 0; border-bottom: 1px solid var(--border); text-align: left; }

    /* ===== Rail ===== */
    .rail { display: none; }
    .rail h3 { margin: 0 0 8px; font-size: 16px; }
    .rail ol, .rail ul { margin: 0; padding-left: 18px; }

    /* ===== Footer ===== */
    footer.site { border-top: 1px solid var(--border); color: var(--muted); font-size: 14px; }
    footer .inner { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; }

    /* ===== Settings dialog ===== */
    dialog.settings { 
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: 1px solid rgba(255, 255, 255, 0.2); 
      border-radius: 12px; 
      padding: 24px; 
      background: color-mix(in srgb, var(--table-bg) 90%, #000); 
      color: #e6e7eb; 
      max-width: 520px; 
      width: calc(100% - 32px);
      backdrop-filter: blur(8px);
      z-index: 1000;
      /* Disable text selection */
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }
    dialog.settings::backdrop { 
      background: rgba(0, 0, 0, 0.7); 
      backdrop-filter: blur(2px);
    }
    .settings h2 { margin: 0 0 16px; font-size: 24px; font-weight: 600; }
    .settings .row { margin: 16px 0; }
    .swatches { 
      display: grid; 
      grid-template-columns: repeat(8, 24px); 
      gap: 6px; 
      justify-content: start;
    }
    .swatch { 
      width: 24px; 
      height: 24px; 
      border: 1px solid rgba(255, 255, 255, 0.2); 
      border-radius: 4px; 
      cursor: pointer; 
      transition: all 0.2s ease;
    }
    .swatch:hover {
      transform: scale(1.05);
      border-color: rgba(255, 255, 255, 0.4);
    }
    .swatch[aria-pressed="true"] { 
      outline: 2px solid #6aa1ff; 
      outline-offset: 2px; 
      transform: scale(1.05);
    }
    .settings .help { font-size: 13px; color: #9aa3ad; margin-top: 8px; }
    .settings .menu { display: flex; justify-content: flex-end; gap: 8px; margin-top: 20px; }
    
    .close-modal {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      color: #e6e7eb;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1;
    }
    
    .close-modal:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .close-modal:focus-visible {
      outline: 2px solid #6aa1ff;
      outline-offset: 2px;
    }

    /* HUD Toggle Styles */
    .hud-toggles {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toggle-group {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .toggle-group label {
      font-size: 14px;
      color: #e6e7eb;
      font-weight: 500;
    }

    .toggle-btn {
      width: 50px;
      height: 26px;
      border: none;
      border-radius: 13px;
      background: #4CAF50; /* Green when on (default) */
      cursor: pointer;
      position: relative;
      transition: background-color 0.3s ease;
    }

    .toggle-btn[aria-pressed="false"] {
      background: #6B7280; /* Gray when off */
    }

    .toggle-slider {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 22px;
      height: 22px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .toggle-btn[aria-pressed="true"] .toggle-slider {
      transform: translateX(24px);
    }

    .toggle-btn:hover {
      opacity: 0.9;
    }

    .toggle-btn:focus-visible {
      outline: 2px solid #6aa1ff;
      outline-offset: 2px;
    }

    /* Radio Button Groups */
    .radio-groups {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .radio-group-label {
      font-size: 14px;
      color: #e6e7eb;
      font-weight: 500;
    }

    .radio-options {
      display: flex;
      gap: 12px;
    }

    .radio-option {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-size: 14px;
      color: #e6e7eb;
    }

    .radio-option input[type="radio"] {
      width: 16px;
      height: 16px;
      margin: 0 6px 0 0;
      cursor: pointer;
      accent-color: #4CAF50;
    }

    .radio-text {
      user-select: none;
    }

    /* Disabled radio options */
    .radio-option.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .radio-option.disabled input[type="radio"] {
      cursor: not-allowed;
    }

    .radio-option.disabled .radio-text {
      color: #6B7280;
      cursor: not-allowed;
    }

    /* Language dropdown in settings */
    .language-dropdown {
      display: flex;
      align-items: center;
      margin-top: 6px;
    }

    .language-select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      background: color-mix(in srgb, var(--table-bg) 70%, transparent);
      color: #e6e7eb;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      backdrop-filter: blur(4px);
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23e6e7eb' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 8px center;
      background-repeat: no-repeat;
      background-size: 16px;
      padding-right: 32px;
      height: 2.5rem;
    }

    .language-select:hover {
      background-color: color-mix(in srgb, var(--table-bg) 80%, transparent);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .language-select:focus-visible {
      outline: 2px solid #fff;
      outline-offset: 2px;
    }

    .language-select option {
      background: color-mix(in srgb, var(--table-bg) 90%, #000);
      color: #e6e7eb;
      padding: 8px 12px;
    }

    /* Menu dialog */
    dialog.menu { border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; background: var(--bg); color: var(--text); max-width: 360px; width: calc(100% - 32px); }
    dialog.menu::backdrop { background: rgba(0,0,0,.35); }
    .menu h2 { margin: 0 0 8px; font-size: 18px; }
    .menu .list { display: flex; flex-direction: column; gap: 8px; }
    .menu .btn { width: 100%; text-align: left; height: 36px; }
  </style>
  
  <!-- Klondike Game Styles -->
  <link rel="stylesheet" href="/games/klondike3/styles.css">
  
  <!-- Klondike Game Engine -->
  <script is:inline src="/games/klondike3/klondike3Engine.js"></script>

</head>
<body data-game="sample-game">
  <a class="visually-hidden" href="#game">Skip to game</a>

  <!-- Game Surface takes full viewport -->
  <GameSurface />
  
  <!-- Main content below the game -->
  <main class="container full">
    <h1 class="visually-hidden">Sample Game</h1>
    <div class="grid">
      <div>
        <HowToPlay />
        <Strategies />
        <FAQ />
        <RelatedGames />
      </div>
    </div>
  </main>

  <Footer />

  <!-- Win Modal -->
  <WinModal />

  <!-- Settings dialog -->
  <dialog id="settingsDlg" class="settings" aria-labelledby="settingsTitle">
    <form method="dialog">
      <button class="close-modal" value="cancel" aria-label="Close Settings">√ó</button>
      <h2 id="settingsTitle">Settings</h2>
      <div class="row">
        <div style="font-weight:600; margin-bottom:6px;">Table background</div>
        <div id="swatchGroup" class="swatches" role="group" aria-label="Table background choices">
          <button type="button" class="swatch" data-color="#4f7942" title="Fern Green" aria-pressed="false" style="background:#4f7942"></button>
          <button type="button" class="swatch" data-color="#145239" title="Forest" aria-pressed="false" style="background:#145239"></button>
          <button type="button" class="swatch" data-color="#0b0c0f" title="Charcoal" aria-pressed="false" style="background:#0b0c0f"></button> 
          <button type="button" class="swatch" data-color="#1f2933" title="Slate" aria-pressed="false" style="background:#1f2933"></button>
          <button type="button" class="swatch" data-color="#0b2748" title="Midnight Blue" aria-pressed="false" style="background:#0b2748"></button>
          <button type="button" class="swatch" data-color="#0f3d3e" title="Teal" aria-pressed="false" style="background:#0f3d3e"></button>
          <button type="button" class="swatch" data-color="#3f1020" title="Burgundy" aria-pressed="false" style="background:#3f1020"></button>
          <button type="button" class="swatch" data-color="#3a2b1e" title="Brown Felt" aria-pressed="false" style="background:#3a2b1e"></button>
          <button type="button" class="swatch" data-color="#689bc4" title="Light Blue" aria-pressed="false" style="background:#689bc4"></button>
          <button type="button" class="swatch" data-color="#d3af8f" title="Light Felt" aria-pressed="false" style="background:#d3af8f"></button>
          <button type="button" class="swatch" data-color="#ffffff" title="White" aria-pressed="false" style="background:#ffffff"></button>
        </div>
      </div>
      <div class="row">
        <div class="hud-toggles">
          <div class="toggle-group">
            <label for="showMovesToggle">Show Moves</label>
            <button type="button" id="showMovesToggle" class="toggle-btn" aria-pressed="true">
              <span class="toggle-slider"></span>
            </button>
          </div>
          <div class="toggle-group">
            <label for="showTimeToggle">Show Time</label>
            <button type="button" id="showTimeToggle" class="toggle-btn" aria-pressed="true">
              <span class="toggle-slider"></span>
            </button>
          </div>
          <div class="toggle-group">
            <label for="soundToggle">Sound</label>
            <button type="button" id="soundToggle" class="toggle-btn" aria-pressed="true">
              <span class="toggle-slider"></span>
            </button>
          </div>
          <div class="toggle-group">
            <label for="animationsToggle">Animations</label>
            <button type="button" id="animationsToggle" class="toggle-btn" aria-pressed="true">
              <span class="toggle-slider"></span>
            </button>
          </div>
          <div class="toggle-group">
            <label for="showScoreToggle">Show Score</label>
            <button type="button" id="showScoreToggle" class="toggle-btn" aria-pressed="true">
              <span class="toggle-slider"></span>
            </button>
          </div>
          <div class="toggle-group">
            <label for="showStockToggle">Show Stock</label>
            <button type="button" id="showStockToggle" class="toggle-btn" aria-pressed="true">
              <span class="toggle-slider"></span>
            </button>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="radio-groups">
          <div class="radio-group">
            <label class="radio-group-label">Autoplay</label>
            <div class="radio-options">
              <label class="radio-option">
                <input type="radio" name="autoplay" value="off" />
                <span class="radio-text">Off</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="autoplay" value="obvious" checked />
                <span class="radio-text">When Obvious</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="autoplay" value="won" />
                <span class="radio-text">When Won</span>
              </label>
            </div>
          </div>
          <div class="radio-group">
            <label class="radio-group-label">Animation Speed</label>
            <div class="radio-options">
              <label class="radio-option">
                <input type="radio" name="animationSpeed" value="slow" />
                <span class="radio-text">Slow</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="animationSpeed" value="normal" checked />
                <span class="radio-text">Normal</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="animationSpeed" value="fast" />
                <span class="radio-text">Fast</span>
              </label>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div style="font-weight:600; margin-bottom:6px;">Language</div>
        <div class="language-dropdown">
          <select id="languageSelect" class="language-select" aria-label="Select Language">
            <option value="en">English</option>
            <option value="de">Deutsch</option>
            <option value="fr">Fran√ßais</option>
            <option value="es">Espa√±ol</option>
            <option value="it">Italiano</option>
            <option value="pt">Portugu√™s</option>
            <option value="nl">Nederlands</option>
            <option value="sv">Svenska</option>
            <option value="da">Dansk</option>
            <option value="no">Norsk</option>
            <option value="fi">Suomi</option>
            <option value="pl">Polski</option>
            <option value="cs">ƒåe≈°tina</option>
            <option value="hu">Magyar</option>
            <option value="ro">Rom√¢nƒÉ</option>
            <option value="bg">–ë—ä–ª–≥–∞—Ä—Å–∫–∏</option>
            <option value="hr">Hrvatski</option>
            <option value="sr">Srpski</option>
            <option value="sl">Sloven≈°ƒçina</option>
            <option value="sk">Slovenƒçina</option>
            <option value="et">Eesti</option>
            <option value="lv">Latvie≈°u</option>
            <option value="lt">Lietuvi≈≥</option>
            <option value="el">ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨</option>
            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
            <option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
            <option value="ja">Êó•Êú¨Ë™û</option>
          </select>
        </div>
      </div>
    </form>
  </dialog>

  <dialog id="menuDlg" class="menu" aria-labelledby="menuTitle">
    <form method="dialog">
      <h2 id="menuTitle">Menu</h2>
      <div class="list">
        <button id="resumeBtn" class="btn" value="default" type="button">Resume</button>
        <button id="restartMenuBtn" class="btn" type="button">Restart</button>
        <button id="openSettingsBtn" class="btn" type="button">Settings</button>
        <button class="btn" value="cancel">Close</button>
      </div>
    </form>
  </dialog>

  <script>
    // Minimal demo logic + table background preference.
    document.addEventListener('DOMContentLoaded', function() {
      const root = document.documentElement;
      
      const edgeMenuBtn = document.getElementById('edgeMenuBtn');
      const menuDlg = document.getElementById('menuDlg');
      
      const gameEngineMount = document.getElementById('gameEngineMount');
      
      const settingsDlg = document.getElementById('settingsDlg');
      const swatchGroup = document.getElementById('swatchGroup');
      const viewport = document.getElementById('game');
      const pauseOverlay = document.getElementById('pauseOverlay');
      const GAME_SLUG = document.body.dataset.game || 'sample-game';

      // Table background color persistence
      const DEFAULT_VELVET = '#4f7942';
      const gameKey = `tableBg.game.${GAME_SLUG}`;
      const globalKey = 'tableBg.default';
      function currentBg() {
        return localStorage.getItem(gameKey) || localStorage.getItem(globalKey) || DEFAULT_VELVET;
      }
      function applyBg(color) { document.documentElement.style.setProperty('--table-bg', color); }
      function markSelected(color) {
        const buttons = swatchGroup.querySelectorAll('.swatch');
        buttons.forEach(b => b.setAttribute('aria-pressed', String(b.dataset.color.toLowerCase() === color.toLowerCase())));
      }
      // init
      applyBg(currentBg());
      markSelected(currentBg());

      // swatch clicks
      swatchGroup.addEventListener('click', (e) => {
        const btn = e.target.closest('.swatch'); if (!btn) return;
        const color = btn.dataset.color;
        applyBg(color); markSelected(color);
        localStorage.setItem(gameKey, color);
      });

      // HUD Toggle functionality
      const showMovesToggle = document.getElementById('showMovesToggle');
      const showTimeToggle = document.getElementById('showTimeToggle');
      const showScoreToggle = document.getElementById('showScoreToggle');
      const showStockToggle = document.getElementById('showStockToggle');
      const hudMoves = document.getElementById('hudMoves');
      const hudTime = document.getElementById('hudTime');
      const hudScore = document.getElementById('hudScore');
      const hudStock = document.getElementById('hudStock');

      // HUD preferences keys
      const movesKey = 'hud.showMoves';
      const timeKey = 'hud.showTime';
      const scoreKey = 'hud.showScore';
      const stockKey = 'hud.showStock';

      // Get saved preferences (default to true)
      function getMovesPreference() {
        const saved = localStorage.getItem(movesKey);
        return saved === null ? true : saved === 'true';
      }
      
      function getTimePreference() {
        const saved = localStorage.getItem(timeKey);
        return saved === null ? true : saved === 'true';
      }
      
      function getScorePreference() {
        const saved = localStorage.getItem(scoreKey);
        return saved === null ? true : saved === 'true';
      }
      
      function getStockPreference() {
        const saved = localStorage.getItem(stockKey);
        return saved === null ? true : saved === 'true';
      }

      // Apply HUD visibility
      function applyHudVisibility() {
        const showMoves = getMovesPreference();
        const showTime = getTimePreference();
        const showScore = getScorePreference();
        const showStock = getStockPreference();
        
        if (hudMoves) hudMoves.style.display = showMoves ? 'block' : 'none';
        if (hudTime) hudTime.style.display = showTime ? 'block' : 'none';
        if (hudScore) hudScore.style.display = showScore ? 'block' : 'none';
        if (hudStock) hudStock.style.display = showStock ? 'block' : 'none';
        
        if (showMovesToggle) showMovesToggle.setAttribute('aria-pressed', String(showMoves));
        if (showTimeToggle) showTimeToggle.setAttribute('aria-pressed', String(showTime));
        if (showScoreToggle) showScoreToggle.setAttribute('aria-pressed', String(showScore));
        if (showStockToggle) showStockToggle.setAttribute('aria-pressed', String(showStock));
      }

      // Toggle event listeners
      showMovesToggle?.addEventListener('click', () => {
        const current = getMovesPreference();
        const newValue = !current;
        localStorage.setItem(movesKey, String(newValue));
        applyHudVisibility();
      });

      showTimeToggle?.addEventListener('click', () => {
        const current = getTimePreference();
        const newValue = !current;
        localStorage.setItem(timeKey, String(newValue));
        applyHudVisibility();
      });

      showScoreToggle?.addEventListener('click', () => {
        const current = getScorePreference();
        const newValue = !current;
        localStorage.setItem(scoreKey, String(newValue));
        applyHudVisibility();
      });

      showStockToggle?.addEventListener('click', () => {
        const current = getStockPreference();
        const newValue = !current;
        localStorage.setItem(stockKey, String(newValue));
        applyHudVisibility();
      });

      // Initialize HUD visibility on page load
      applyHudVisibility();

      // New Settings functionality
      const soundToggle = document.getElementById('soundToggle');
      const animationsToggle = document.getElementById('animationsToggle');
      const autoplayRadios = document.querySelectorAll('input[name="autoplay"]');
      const animationSpeedRadios = document.querySelectorAll('input[name="animationSpeed"]');

      // Settings keys
      const soundKey = 'game.sound';
      const animationsKey = 'game.animations';
      const autoplayKey = 'game.autoplay';
      const animationSpeedKey = 'game.animationSpeed';

      // Get preferences with defaults
      function getSoundPreference() {
        const saved = localStorage.getItem(soundKey);
        return saved === null ? true : saved === 'true';
      }

      function getAnimationsPreference() {
        const saved = localStorage.getItem(animationsKey);
        return saved === null ? true : saved === 'true';
      }

      function getAutoplayPreference() {
        return localStorage.getItem(autoplayKey) || 'obvious';
      }

      function getAnimationSpeedPreference() {
        return localStorage.getItem(animationSpeedKey) || 'normal';
      }

      // Apply settings
      function applySettings() {
        const sound = getSoundPreference();
        const animations = getAnimationsPreference();
        const autoplay = getAutoplayPreference();
        const animationSpeed = getAnimationSpeedPreference();

        if (soundToggle) soundToggle.setAttribute('aria-pressed', String(sound));
        if (animationsToggle) animationsToggle.setAttribute('aria-pressed', String(animations));

        // Set radio button selections
        autoplayRadios.forEach(radio => {
          radio.checked = radio.value === autoplay;
        });

        animationSpeedRadios.forEach(radio => {
          radio.checked = radio.value === animationSpeed;
        });

        // Enable/disable Animation Speed based on Animations toggle
        animationSpeedRadios.forEach(radio => {
          radio.disabled = !animations;
          const radioOption = radio.closest('.radio-option');
          if (radioOption) {
            if (animations) {
              radioOption.classList.remove('disabled');
            } else {
              radioOption.classList.add('disabled');
            }
          }
        });
      }

      // Toggle event listeners
      soundToggle?.addEventListener('click', () => {
        const current = getSoundPreference();
        const newValue = !current;
        localStorage.setItem(soundKey, String(newValue));
        applySettings();
      });

      animationsToggle?.addEventListener('click', () => {
        const current = getAnimationsPreference();
        const newValue = !current;
        localStorage.setItem(animationsKey, String(newValue));
        applySettings();
      });

      // Radio button event listeners
      autoplayRadios.forEach(radio => {
        radio.addEventListener('change', () => {
          if (radio.checked) {
            localStorage.setItem(autoplayKey, radio.value);
          }
        });
      });

      animationSpeedRadios.forEach(radio => {
        radio.addEventListener('change', () => {
          if (radio.checked) {
            localStorage.setItem(animationSpeedKey, radio.value);
          }
        });
      });

      // Initialize settings on page load
      applySettings();

      // Language Selection functionality
      const languageSelect = document.getElementById('languageSelect');
      const languageKey = 'user.language';

      // Language names in their own languages
      const languageNames = {
        'en': 'English',
        'de': 'Deutsch',
        'fr': 'Fran√ßais',
        'es': 'Espa√±ol',
        'it': 'Italiano',
        'pt': 'Portugu√™s',
        'nl': 'Nederlands',
        'sv': 'Svenska',
        'da': 'Dansk',
        'no': 'Norsk',
        'fi': 'Suomi',
        'pl': 'Polski',
        'cs': 'ƒåe≈°tina',
        'hu': 'Magyar',
        'ro': 'Rom√¢nƒÉ',
        'bg': '–ë—ä–ª–≥–∞—Ä—Å–∫–∏',
        'hr': 'Hrvatski',
        'sr': 'Srpski',
        'sl': 'Sloven≈°ƒçina',
        'sk': 'Slovenƒçina',
        'et': 'Eesti',
        'lv': 'Latvie≈°u',
        'lt': 'Lietuvi≈≥',
        'el': 'ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨',
        'ru': '–†—É—Å—Å–∫–∏–π',
        'uk': '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞',
        'ja': 'Êó•Êú¨Ë™û'
      };

      // Get saved language preference (default to English)
      function getLanguagePreference() {
        return localStorage.getItem(languageKey) || 'en';
      }

      // Set language selection and display
      function applyLanguageSelection() {
        const selectedLang = getLanguagePreference();
        if (languageSelect) {
          languageSelect.value = selectedLang;
        }
      }

      // Language selection event listener
      languageSelect?.addEventListener('change', (e) => {
        const selectedLang = e.target.value;
        localStorage.setItem(languageKey, selectedLang);
        console.log(`Language changed to: ${languageNames[selectedLang]} (${selectedLang})`);
      });

      // Initialize language selection on page load
      applyLanguageSelection();

      // Settings modal behavior
      function showSettings() {
        if (typeof settingsDlg?.showModal === 'function') {
          settingsDlg.showModal();
        } else {
          settingsDlg?.setAttribute('open', '');
        }
        // Game continues running when settings are opened
      }

      function closeSettings() {
        if (settingsDlg.open) {
          settingsDlg.close();
        }
        // Game remains paused - user can resume manually
      }

      // Settings button event listener
      const vpSettingsBtn = document.getElementById('vpSettingsBtn');
      
      if (vpSettingsBtn) {
        vpSettingsBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          showSettings();
        });
      } else {
        // Fallback: try to find by class
        const settingsBtn = document.querySelector('.settings-btn');
        if (settingsBtn) {
          settingsBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            showSettings();
          });
        }
      }

      // Close settings when clicking outside
      settingsDlg.addEventListener('click', (e) => {
        const rect = settingsDlg.getBoundingClientRect();
        const isInDialog = (rect.top <= e.clientY && e.clientY <= rect.top + rect.height &&
                          rect.left <= e.clientX && e.clientX <= rect.left + rect.width);
        if (!isInDialog) {
          closeSettings();
        }
      });

      // Close settings with Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && settingsDlg.open) {
          e.preventDefault();
          closeSettings();
        }
      });

      // Minimal control model: no visible play/pause/restart. Menu + shortcuts.
      function showMenu() {
        if (typeof menuDlg.showModal === 'function') menuDlg.showModal();
        else menuDlg.setAttribute('open', '');
      }
      function closeMenu() { if (menuDlg.open) menuDlg.close(); }
      function pauseGame() {
        stopTimer();
        
        // Immediately show overlay
        const pauseOverlay = document.getElementById('pauseOverlay');
        if (pauseOverlay) {
          pauseOverlay.classList.add('show');
        }
        
        // Update button display
        updateTimerDisplay();
      }
      
      function resumeGame() {
        startTimer();
        
        // Immediately hide overlay
        const pauseOverlay = document.getElementById('pauseOverlay');
        if (pauseOverlay) {
          pauseOverlay.classList.remove('show');
        }
        
        // Update button display
        updateTimerDisplay();
      }

      const resumeBtn = document.getElementById('resumeBtn');
      const restartMenuBtn = document.getElementById('restartMenuBtn');
      const openSettingsBtn = document.getElementById('openSettingsBtn');

      edgeMenuBtn?.addEventListener('click', () => { showMenu(); });
      resumeBtn?.addEventListener('click', () => { resumeGame(); closeMenu(); });
      restartMenuBtn?.addEventListener('click', () => { 
        resetTimer(); 
        // Reset game state but keep paused state
        if (gameEngine) {
          gameEngine.startNewDeal();
        }
        closeMenu(); 
      });

      // Wire up New Deal button to engine interface
      const newDealBtn = document.getElementById('newDealBtn');
      newDealBtn?.addEventListener('click', () => {
        // Reset game stats and timer
        resetTimer();
        const hudMoves = document.getElementById('hudMoves');
        const hudScore = document.getElementById('hudScore');
        const hudStock = document.getElementById('hudStock');
        
        if (hudMoves) hudMoves.textContent = 'Moves: 0';
        if (hudScore) hudScore.textContent = 'Score: 0';
        if (hudStock) hudStock.textContent = 'Stock: 24';
        
        // Call engine's startNewDeal() when available
        if (gameEngine) {
          gameEngine.startNewDeal();
        }
        
        // Don't automatically resume - let user click play when ready
        // Just ensure pause state is correct
        const pauseOverlay = document.getElementById('pauseOverlay');
        if (pauseOverlay) pauseOverlay.classList.remove('show');
        
        const pausePlayBtn = document.getElementById('pausePlayBtn');
        if (pausePlayBtn) {
          pausePlayBtn.textContent = '‚ñ∂';
          pausePlayBtn.setAttribute('aria-label', 'Play');
          pausePlayBtn.setAttribute('title', 'Play');
        }
      });

      // More dropdown functionality
      const moreDropdown = document.querySelector('.more-dropdown');
      const moreTrigger = document.getElementById('moreTrigger');
      const moreDropdownMenu = document.getElementById('moreDropdownMenu');
      
      console.log('More dropdown elements found:');
      console.log('moreDropdown:', moreDropdown);
      console.log('moreTrigger:', moreTrigger);
      console.log('moreDropdownMenu:', moreDropdownMenu);
      
      // Toggle dropdown on trigger click
      moreTrigger?.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('More trigger clicked!');
        
        if (moreDropdown) {
          const isOpen = moreDropdown.classList.contains('open');
          console.log('Dropdown current state:', isOpen ? 'open' : 'closed');
          
          if (isOpen) {
            moreDropdown.classList.remove('open');
            console.log('Dropdown closed');
          } else {
            moreDropdown.classList.add('open');
            console.log('Dropdown opened');
          }
        } else {
          console.error('More dropdown element not found!');
        }
      });
      
      // Handle dropdown option clicks
      moreDropdownMenu?.addEventListener('click', (e) => {
        const option = (e.target as Element).closest('.more-option') as HTMLElement;
        if (option && option.dataset.value) {
          const selectedOption = option.dataset.value;
          console.log(`More option selected: ${selectedOption}`);
          
          // Close dropdown after selection
          if (moreDropdown) {
            moreDropdown.classList.remove('open');
          }
          
          // Handle different options
          switch (selectedOption) {
            case 'account':
              console.log('Opening Account...');
              // TODO: Implement account functionality
              break;
            case 'leaderboard':
              console.log('Opening Leaderboard...');
              // TODO: Implement leaderboard functionality
              break;
            case 'daily-challenge':
              console.log('Opening Daily Challenge...');
              // TODO: Implement daily challenge functionality
              break;
            case 'rules':
              console.log('Opening Rules...');
              // TODO: Implement rules functionality
              break;
            case 'help':
              console.log('Opening Help...');
              // TODO: Implement help functionality
              break;
          }
        }
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (moreDropdown && !moreDropdown.contains(e.target as Node)) {
          moreDropdown.classList.remove('open');
        }
      });

      openSettingsBtn?.addEventListener('click', () => { closeMenu(); markSelected(currentBg()); if (typeof settingsDlg.showModal === 'function') settingsDlg.showModal(); else settingsDlg.setAttribute('open',''); });

      // ===== GAME ENGINE INTEGRATION =====
      
      let gameEngine = {
        startNewDeal: () => {},
        updateOptions: (options) => {},
        destroy: () => {}
      };
      let gameStats = {
        gamesPlayed: parseInt(localStorage.getItem('stats.gamesPlayed') || '0'),
        gamesWon: parseInt(localStorage.getItem('stats.gamesWon') || '0'),
        deals: parseInt(localStorage.getItem('stats.deals') || '0')
      };
      
      // Timer system
      let gameTimer = {
        startTime: null,
        elapsed: 0,
        isRunning: false,
        interval: null
      };
      
      function startTimer() {
        if (gameTimer.isRunning) return;
        gameTimer.startTime = Date.now() - (gameTimer.elapsed * 1000); // Account for previous elapsed time
        gameTimer.isRunning = true;
        gameTimer.interval = setInterval(() => {
          gameTimer.elapsed = Math.floor((Date.now() - gameTimer.startTime) / 1000);
          updateTimerDisplay();
        }, 1000);
        
        // Update display immediately
        updateTimerDisplay();
      }
      
      function stopTimer() {
        gameTimer.isRunning = false;
        if (gameTimer.interval) {
          clearInterval(gameTimer.interval);
          gameTimer.interval = null;
        }
      }
      
      function resetTimer() {
        stopTimer();
        gameTimer.elapsed = 0;
        gameTimer.startTime = null;
        updateTimerDisplay();
      }
      
      function updateTimerDisplay() {
        const minutes = Math.floor(gameTimer.elapsed / 60);
        const seconds = gameTimer.elapsed % 60;
        const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        const timeDisplay = document.getElementById('timeDisplay');
        const pausePlayBtn = document.getElementById('pausePlayBtn');
        
        if (timeDisplay) timeDisplay.textContent = timeStr;
        
        if (pausePlayBtn) {
          if (gameTimer.isRunning) {
            pausePlayBtn.innerHTML = `‚è∏`;
            pausePlayBtn.setAttribute('aria-label', 'Pause');
            pausePlayBtn.setAttribute('title', 'Pause');
            pausePlayBtn.style.display = 'flex';
          } else {
            pausePlayBtn.innerHTML = ``;
            pausePlayBtn.setAttribute('aria-label', 'Start');
            pausePlayBtn.setAttribute('title', 'Start');
            pausePlayBtn.style.display = 'none';
          }
        }
      }
      
      // Initialize timer display on page load
      updateTimerDisplay();
      
      // Shell callbacks for game engine
      const shellCallbacks = {
        onFirstMove: () => {
          console.log('üéÆ First move detected, starting timer');
          startTimer();
        },
        
        onMove: (moveData) => {
          console.log('üéÆ Move:', moveData);
          // Update HUD elements
          const hudMoves = document.getElementById('hudMoves');
          const hudScore = document.getElementById('hudScore');
          const hudStock = document.getElementById('hudStock');
          
          if (hudMoves) hudMoves.textContent = `Moves: ${moveData.moves}`;
          if (hudScore) hudScore.textContent = `Score: ${moveData.score}`;
          if (hudStock && moveData.stockCount !== undefined) {
            hudStock.textContent = `Stock: ${moveData.stockCount}`;
          }
        },
        
        onWin: (winData) => {
          console.log('üéâ Game won!', winData);
          stopTimer();
          gameStats.gamesWon++;
          localStorage.setItem('stats.gamesWon', gameStats.gamesWon.toString());
          showWinModal(winData);
        },
        
        onLoss: (lossData) => {
          console.log('üòû Game lost', lossData);
          stopTimer();
          // Could show loss modal here if needed
        },
        
        onReset: () => {
          console.log('üîÑ Game reset');
          resetTimer();
          gameStats.deals++;
          gameStats.gamesPlayed++;
          localStorage.setItem('stats.deals', gameStats.deals.toString());
          localStorage.setItem('stats.gamesPlayed', gameStats.gamesPlayed.toString());
        }
      };
      
      // Win modal functions
      function showWinModal(winData) {
        const winModal = document.getElementById('winModal');
        const winTime = document.getElementById('winTime');
        const winMoves = document.getElementById('winMoves');
        const winScore = document.getElementById('winScore');
        const winGamesWon = document.getElementById('winGamesWon');
        const winRate = document.getElementById('winRate');
        
        if (winTime) winTime.textContent = winData.timeDisplay || formatTime(winData.timeSeconds || gameTimer.elapsed);
        if (winMoves) winMoves.textContent = winData.moves.toString();
        if (winScore) winScore.textContent = winData.score.toString();
        if (winGamesWon) winGamesWon.textContent = gameStats.gamesWon.toString();
        
        const rate = gameStats.gamesPlayed > 0 ? Math.round((gameStats.gamesWon / gameStats.gamesPlayed) * 100) : 0;
        if (winRate) winRate.textContent = `${rate}%`;
        
        if (winModal && typeof winModal.showModal === 'function') {
          winModal.showModal();
        } else if (winModal) {
          winModal.setAttribute('open', '');
        }
      }
      
      function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      }
      
      // Initialize the Klondike game engine
      function initializeGameEngine() {
        const gameEngineMount = document.getElementById('stage');
        if (!gameEngineMount) {
          console.error('Game mount point not found');
          return;
        }
        
        // Check if Klondike3Engine is available
        if (typeof Klondike3Engine === 'undefined') {
          console.error('Klondike3Engine not loaded');
          return;
        }
        
        // Create and mount the Klondike engine
        gameEngine = new Klondike3Engine();
        gameEngine.mount(gameEngineMount, shellCallbacks);
        
        console.log('üéÆ Klondike Draw 3 Solitaire engine initialized');
      }
      
      // Helper functions for preferences (renamed to avoid conflicts)
      function gameAutoplayPreference() {
        return localStorage.getItem('game.autoplay') || 'whenObvious';
      }
      
      function gameAnimationSpeedPreference() {
        return localStorage.getItem('game.animationSpeed') || 'normal';
      }
      
      function gameSoundPreference() {
        return localStorage.getItem('game.sound') !== 'false';
      }
      
      function gameAnimationPreference() {
        return localStorage.getItem('game.animations') !== 'false';
      }
      
      function gameHUDPreference(hudElement) {
        return localStorage.getItem(`hud.${hudElement}`) !== 'false';
      }
      
      // Game controls integrated with existing New Deal button
      
      // Win modal event listeners
      const playAgainBtn = document.getElementById('playAgainBtn');
      const shareScoreBtn = document.getElementById('shareScoreBtn');
      
      playAgainBtn?.addEventListener('click', () => {
        const winModal = document.getElementById('winModal');
        if (winModal) winModal.close();
        
        if (gameEngine) {
          gameEngine.startNewDeal();
        }
      });
      
      shareScoreBtn?.addEventListener('click', () => {
        const timeText = document.getElementById('winTime')?.textContent || '00:00';
        const movesText = document.getElementById('winMoves')?.textContent || '0';
        const scoreText = document.getElementById('winScore')?.textContent || '0';
        
        const shareText = `I just won Klondike Solitaire! Time: ${timeText}, Moves: ${movesText}, Score: ${scoreText}`;
        
        if (navigator.share) {
          navigator.share({
            title: 'Klondike Solitaire Win!',
            text: shareText
          });
        } else {
          navigator.clipboard.writeText(shareText).then(() => {
            alert('Score copied to clipboard!');
          });
        }
      });
      
      // Initialize game engine when DOM is ready
      // Delay initialization to ensure DOM and scripts are loaded
      setTimeout(() => {
        initializeGameEngine();
      }, 100);
      
      // Timer will start when user first clicks the play button
      
      // Pause/Play button functionality with retry mechanism
      function setupPausePlayButton() {
        const pausePlayBtn = document.getElementById('pausePlayBtn');
        console.log('Pause/Play button element:', pausePlayBtn);
        
        if (pausePlayBtn) {
          console.log('Adding event listener to pause/play button');
          pausePlayBtn.addEventListener('click', (e) => {
            console.log('Pause/Play button clicked!');
            e.preventDefault();
            e.stopPropagation();
            
            if (gameTimer.isRunning) {
              console.log('Pausing game...');
              pauseGame();
            } else {
              console.log('Resuming game...');
              resumeGame();
            }
          });
          return true;
        } else {
          console.error('Pause/Play button not found, retrying...');
          return false;
        }
      }
      
      // Try to setup the button, retry if not found
      if (!setupPausePlayButton()) {
        setTimeout(() => {
          setupPausePlayButton();
        }, 100);
      }
      
      // Setup unpause button in overlay
      const unpauseBtn = document.getElementById('unpauseBtn');
      unpauseBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        resumeGame();
      });
      
      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
        if (tag === 'input' || tag === 'textarea' || tag === 'select') return;
        if (e.key === 'Escape') { e.preventDefault(); menuDlg.open ? closeMenu() : showMenu(); }
        else if (e.key.toLowerCase() === 'p') { e.preventDefault(); gameTimer.isRunning ? pauseGame() : resumeGame(); }
      });

      // ===== Game Switcher logic =====
      const switcherTrigger = document.getElementById('switcherTrigger');
      const switcherDropdown = document.getElementById('switcherDropdown');
      const currentGameName = document.getElementById('currentGameName');
      
      // Game data mapping
      const gameData = {
        'klondike-solitaire': 'Klondike Solitaire',
        'spider-solitaire': 'Spider Solitaire',
        'freecell': 'FreeCell',
        'hearts': 'Hearts',
        'minesweeper-classic': 'Minesweeper Classic',
        '2048': '2048'
      };
      
      // Load saved game from localStorage or default to klondike
      const savedGame = localStorage.getItem('selectedGame') || 'klondike-solitaire';
      if (currentGameName && gameData[savedGame]) {
        currentGameName.textContent = gameData[savedGame];
      }
      
      // Handle dropdown option clicks
      switcherDropdown?.addEventListener('click', (e) => {
        const option = e.target.closest('.switcher-option');
        if (option && option.dataset.value) {
          const selectedGame = option.dataset.value;
          console.log(`Switching to game: ${selectedGame}`);
          
          // Save selection to localStorage
          localStorage.setItem('selectedGame', selectedGame);
          
          // Update display
          if (currentGameName && gameData[selectedGame]) {
            currentGameName.textContent = gameData[selectedGame];
          }
          
          // Navigate to the game page
          window.location.href = `/game/${selectedGame}`;
        }
      });
    });
  </script>
</body>
</html>
